import React, { useEffect, useState } from 'react'
import { AxiosError } from 'axios'
import { Outlet, NavLink } from 'react-router-dom'
import { toast } from 'react-toastify'
import { getSession } from '../../requests/session'
import './styles.css'

export const AppLayout: React.FC = () => {
    const [navOpen, setNavOpen] = useState(false)

    const logout = () => {
        localStorage.clear()
        window.location.href = "/"
    }

    useEffect(() => {
        const checkAuth = async () => {
            try {
                await getSession()
            } catch (err) {
                if ((err as AxiosError).status === 400) {
                    toast.error('Your session has expired. Logging you out...')
                    setTimeout(() => logout(), 2000)
                }
            }
        }
        window.addEventListener('focus', checkAuth)

        return () => {
            window.removeEventListener('focus', checkAuth)
        }
    }, [])

    const toggleNav = () => {
        setNavOpen(!navOpen)
    }

    return (
        <div className="app-layout">
            <header>
                <button className="mobile-toggle-nav" onClick={toggleNav}>
                    <svg width="34" height="34" viewBox="0 0 34 34" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M4.25 24.0833H29.75M4.25 17H29.75M4.25 9.91663H29.75" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/> </svg>
                </button>
                <img src="/assets/logo.png" width={38} height={38} />
                <span>Lowry Construction and Mechanical</span>
                <button onClick={logout}>
                    Log Out
                </button>
            </header>
            <nav className={navOpen ? 'mobile-nav-open' : ''}>
                <NavLink to="/app/dashboard">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M2 8.66667H7.33333V2H2V8.66667ZM2 14H7.33333V10H2V14ZM8.66667 14H14V7.33333H8.66667V14ZM8.66667 2V6H14V2H8.66667Z" fill="#636184"/> </svg>
                    <span>Dashboard</span>
                </NavLink>
                <NavLink to="/app/customers">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M10 7C11.1067 7 11.9933 6.10667 11.9933 5C11.9933 3.89333 11.1067 3 10 3C8.89333 3 8 3.89333 8 5C8 6.10667 8.89333 7 10 7ZM4.66667 7C5.77333 7 6.66 6.10667 6.66 5C6.66 3.89333 5.77333 3 4.66667 3C3.56 3 2.66667 3.89333 2.66667 5C2.66667 6.10667 3.56 7 4.66667 7ZM4.66667 8.33333C3.11333 8.33333 0 9.11333 0 10.6667V11.6667C0 12.0333 0.3 12.3333 0.666667 12.3333H8.66667C9.03333 12.3333 9.33333 12.0333 9.33333 11.6667V10.6667C9.33333 9.11333 6.22 8.33333 4.66667 8.33333ZM10 8.33333C9.80667 8.33333 9.58667 8.34667 9.35333 8.36667C9.36667 8.37333 9.37333 8.38667 9.38 8.39333C10.14 8.94667 10.6667 9.68667 10.6667 10.6667V11.6667C10.6667 11.9 10.62 12.1267 10.5467 12.3333H14C14.3667 12.3333 14.6667 12.0333 14.6667 11.6667V10.6667C14.6667 9.11333 11.5533 8.33333 10 8.33333Z" fill="#636184"/> </svg>
                    <span>Customers</span>
                </NavLink>
                <NavLink to="/app/work-orders">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M8.625 6.2V2.9L12.0625 6.2M4.25 2C3.55625 2 3 2.534 3 3.2V12.8C3 13.1183 3.1317 13.4235 3.36612 13.6485C3.60054 13.8736 3.91848 14 4.25 14H11.75C12.0815 14 12.3995 13.8736 12.6339 13.6485C12.8683 13.4235 13 13.1183 13 12.8V5.6L9.25 2H4.25Z" fill="#636184"/> </svg>
                    <span>Work Orders</span>
                </NavLink>
                <NavLink to="/app/service-contracts">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"> <path fill-rule="evenodd" clip-rule="evenodd" d="M7.296 0.833374H8.704C9.92933 0.833374 10.9 0.833374 11.6593 0.935374C12.4407 1.04071 13.0733 1.26204 13.5727 1.76071C14.0713 2.26004 14.2927 2.89271 14.398 3.67404C14.5 4.43404 14.5 5.40404 14.5 6.62937V9.37071C14.5 10.596 14.5 11.5667 14.398 12.326C14.2927 13.1074 14.0713 13.74 13.5727 14.2394C13.0733 14.738 12.4407 14.9594 11.6593 15.0647C10.8993 15.1667 9.92933 15.1667 8.704 15.1667H7.296C6.07067 15.1667 5.1 15.1667 4.34067 15.0647C3.55933 14.9594 2.92667 14.738 2.42733 14.2394C1.92867 13.74 1.70733 13.1074 1.602 12.326C1.5 11.566 1.5 10.596 1.5 9.37071V6.62937C1.5 5.40404 1.5 4.43337 1.602 3.67404C1.70733 2.89271 1.92867 2.26004 2.42733 1.76071C2.92667 1.26204 3.55933 1.04071 4.34067 0.935374C5.10067 0.833374 6.07067 0.833374 7.296 0.833374ZM4.47333 1.92671C3.80267 2.01671 3.416 2.18604 3.13333 2.46804C2.852 2.75004 2.68267 3.13671 2.59267 3.80737C2.50067 4.49271 2.49933 5.39537 2.49933 6.66671V9.33337C2.49933 10.6047 2.50067 11.508 2.59267 12.1934C2.68267 12.8634 2.852 13.25 3.134 13.532C3.416 13.814 3.80267 13.9834 4.47333 14.0734C5.15867 14.1654 6.06133 14.1667 7.33267 14.1667H8.666C9.93733 14.1667 10.8407 14.1654 11.526 14.0734C12.196 13.9834 12.5827 13.814 12.8647 13.532C13.1467 13.25 13.316 12.8634 13.406 12.1927C13.498 11.508 13.4993 10.6047 13.4993 9.33337V6.66671C13.4993 5.39537 13.498 4.49271 13.406 3.80671C13.316 3.13671 13.1467 2.75004 12.8647 2.46804C12.5827 2.18604 12.196 2.01671 11.5253 1.92671C10.8407 1.83471 9.93733 1.83337 8.666 1.83337H7.33267C6.06133 1.83337 5.15933 1.83471 4.47333 1.92671ZM4.83333 6.66671C4.83333 6.5341 4.88601 6.40692 4.97978 6.31315C5.07355 6.21939 5.20073 6.16671 5.33333 6.16671H10.6667C10.7993 6.16671 10.9265 6.21939 11.0202 6.31315C11.114 6.40692 11.1667 6.5341 11.1667 6.66671C11.1667 6.79932 11.114 6.92649 11.0202 7.02026C10.9265 7.11403 10.7993 7.16671 10.6667 7.16671H5.33333C5.20073 7.16671 5.07355 7.11403 4.97978 7.02026C4.88601 6.92649 4.83333 6.79932 4.83333 6.66671ZM4.83333 9.33337C4.83333 9.20077 4.88601 9.07359 4.97978 8.97982C5.07355 8.88605 5.20073 8.83337 5.33333 8.83337H8.66667C8.79927 8.83337 8.92645 8.88605 9.02022 8.97982C9.11399 9.07359 9.16667 9.20077 9.16667 9.33337C9.16667 9.46598 9.11399 9.59316 9.02022 9.68693C8.92645 9.7807 8.79927 9.83337 8.66667 9.83337H5.33333C5.20073 9.83337 5.07355 9.7807 4.97978 9.68693C4.88601 9.59316 4.83333 9.46598 4.83333 9.33337Z" fill="#636184"/> </svg>
                    <span>Service Contracts</span>
                </NavLink>
                <NavLink to="/app/projects">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M14 2H2.5C2.22344 2 2 2.22344 2 2.5V14C2 14.2766 2.22344 14.5 2.5 14.5H14C14.2766 14.5 14.5 14.2766 14.5 14V2.5C14.5 2.22344 14.2766 2 14 2ZM6 11.875C6 11.9438 5.94375 12 5.875 12H4.625C4.55625 12 4.5 11.9438 4.5 11.875V4.625C4.5 4.55625 4.55625 4.5 4.625 4.5H5.875C5.94375 4.5 6 4.55625 6 4.625V11.875ZM9 7.5C9 7.56875 8.94375 7.625 8.875 7.625H7.625C7.55625 7.625 7.5 7.56875 7.5 7.5V4.625C7.5 4.55625 7.55625 4.5 7.625 4.5H8.875C8.94375 4.5 9 4.55625 9 4.625V7.5ZM12 8.625C12 8.69375 11.9438 8.75 11.875 8.75H10.625C10.5562 8.75 10.5 8.69375 10.5 8.625V4.625C10.5 4.55625 10.5562 4.5 10.625 4.5H11.875C11.9438 4.5 12 4.55625 12 4.625V8.625Z" fill="#636184"/> </svg>
                    <span>Projects</span>
                </NavLink>
                <NavLink to="/app/messages">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M6.15385 0C2.79815 0 0 2.30769 0 5.23077C0 6.72615 0.818462 8.02954 1.98092 8.98092C1.90586 9.48644 1.70034 9.96367 1.38462 10.3655C1.25577 10.5305 1.12112 10.6908 0.980923 10.8462C0.908349 10.9226 0.843807 11.0064 0.788308 11.096C0.753231 11.1532 0.698461 11.2172 0.673231 11.3465C0.647385 11.4751 0.682462 11.6868 0.788308 11.8462L0.865231 11.9809L1.01908 12.0578C1.55754 12.3268 2.13908 12.2794 2.67323 12.1348C3.20677 11.9895 3.72 11.7409 4.21169 11.4806C4.70277 11.2209 5.16985 10.9489 5.53846 10.7502C5.59015 10.7225 5.62338 10.7157 5.67323 10.6923C6.64369 12.0265 8.42092 12.9231 10.4037 12.9231C10.4228 12.9255 10.4406 12.9231 10.4615 12.9231C11.2615 12.9231 13.8462 15.5655 15.3846 14.5194C15.4462 14.2738 14.032 13.6578 13.9612 11.8271C15.1655 10.976 15.9428 9.71015 15.9428 8.30769C15.9428 6.23262 14.296 4.51815 12.0966 3.904C11.4006 1.63938 8.98092 0 6.15385 0ZM6.15385 1.23077C8.952 1.23077 11.0769 3.10769 11.0769 5.23077C11.0769 7.35385 8.952 9.23077 6.15385 9.23077C5.65415 9.23077 5.36738 9.43508 4.96123 9.65415C4.55508 9.87262 4.08923 10.144 3.63446 10.3846C3.24062 10.5926 2.86523 10.7526 2.51938 10.8652C2.856 10.3791 3.20738 9.73969 3.26892 8.84615L3.28862 8.49969L3 8.28862C1.90338 7.52 1.23077 6.41415 1.23077 5.23077C1.23077 3.10769 3.35569 1.23077 6.15385 1.23077Z" fill="#636184"/> </svg>
                    <span>Message Center</span>
                </NavLink>
                <NavLink to="/app/users">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"> <g clip-path="url(#clip0_84_1044)"> <path d="M12.6667 11.3334V12.6667H4.66667V11.3334C4.66667 11.3334 4.66667 8.66671 8.66667 8.66671C12.6667 8.66671 12.6667 11.3334 12.6667 11.3334ZM10.6667 5.33337C10.6667 4.93781 10.5494 4.55113 10.3296 4.22223C10.1098 3.89334 9.79749 3.63699 9.43203 3.48562C9.06658 3.33424 8.66445 3.29463 8.27649 3.3718C7.88852 3.44897 7.53216 3.63946 7.25245 3.91916C6.97275 4.19887 6.78227 4.55523 6.7051 4.94319C6.62793 5.33116 6.66753 5.73329 6.81891 6.09874C6.97028 6.46419 7.22663 6.77655 7.55553 6.99631C7.88442 7.21608 8.2711 7.33337 8.66667 7.33337C9.1971 7.33337 9.70581 7.12266 10.0809 6.74759C10.456 6.37252 10.6667 5.86381 10.6667 5.33337ZM12.8 8.70671C13.1644 9.04291 13.4582 9.44833 13.6643 9.89932C13.8703 10.3503 13.9844 10.8378 14 11.3334V12.6667H16V11.3334C16 11.3334 16 9.03338 12.8 8.70671ZM12 3.33337C11.7986 3.3335 11.5984 3.36498 11.4067 3.42671C11.7967 3.98602 12.0058 4.6515 12.0058 5.33337C12.0058 6.01525 11.7967 6.68073 11.4067 7.24004C11.5984 7.30177 11.7986 7.33325 12 7.33337C12.5304 7.33337 13.0391 7.12266 13.4142 6.74759C13.7893 6.37252 14 5.86381 14 5.33337C14 4.80294 13.7893 4.29423 13.4142 3.91916C13.0391 3.54409 12.5304 3.33337 12 3.33337ZM5.33333 6.66671H3.33333V4.66671H2V6.66671H0V8.00004H2V10H3.33333V8.00004H5.33333V6.66671Z" fill="#636184"/> </g> <defs> <clipPath id="clip0_84_1044"> <rect width="16" height="16" fill="white"/> </clipPath> </defs> </svg>
                    <span>Users</span>
                </NavLink>
            </nav>
            <div className="app-content" onClick={() => setNavOpen(false)}>
                <Outlet />
            </div>
        </div>
    )
}
